<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>C치mara + Env칤o M칰ltiple (WebP)</title>
</head>

<input
  type="text"
  id="tituloVisual"
  placeholder="Escribe el t칤tulo aqu칤"
  style="width:320px; font-size:16px; margin-bottom:10px;"
>


<body>

  <h3>C치mara</h3>

  <video id="video" width="320" height="240" autoplay playsinline></video>

  <br><br>

  <button onclick="abrirCamara()">Abrir c치mara</button>
  <button onclick="tomarImagen()">Tomar imagen</button>
  <button onclick="enviarImagenes()">Enviar im치genes</button>

  <br><br>

  <div id="galeria"></div>

  <canvas id="canvas" style="display:none;"></canvas>

  <hr>

  <h4>Base64 acumulado (debug)</h4>
  <textarea id="visual" rows="6" cols="50" readonly></textarea>

  <script>
    let stream = null;

    // 游댮 AQU칈 SE GUARDAN TODAS LAS IM츼GENES
    let imagenes = [];

    const URL_GAS = "https://script.google.com/macros/s/AKfycbwsC-K5w5HzlL9ByQ4fwWUUjS0HviZgmstrZnY4tBjNYp7KfnQ9qSxpYl_pxog6fLkQ/exec";

    function abrirCamara() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(s => {
          stream = s;
          video.srcObject = stream;
        })
        .catch(() => alert("No se pudo abrir la c치mara"));
    }

    function tomarImagen() {
      if (!video.srcObject) {
        alert("Primero abre la c치mara");
        return;
      }

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const galeria = document.getElementById("galeria");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      // Blanco y negro
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        const g = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
        data[i] = data[i+1] = data[i+2] = g;
      }
      ctx.putImageData(imgData, 0, 0);

      // 游녤 WebP
      const dataURL = canvas.toDataURL("image/webp", 0.8);

      // Guardar en array
      imagenes.push(dataURL);

      // Mostrar miniatura
      const img = document.createElement("img");
      img.src = dataURL;
      img.width = 120;
      img.style.margin = "5px";
      galeria.appendChild(img);

      // Debug (solo para ver)
      document.getElementById("visual").value =
        `Im치genes almacenadas: ${imagenes.length}`;
    }

    function enviarImagenes() {
      if (imagenes.length === 0) {
        alert("No hay im치genes para enviar");
        return;
      }

      const titulo = document.getElementById("tituloVisual").value.trim();

      if (!titulo) {
        alert("Escribe un t칤tulo antes de enviar");
        return;
      }

      fetch(URL_GAS, {
        method: "POST",
        body: new URLSearchParams({
          titulo: titulo,
          imagenes: JSON.stringify(imagenes)
        })
      })
      .then(r => r.text())
      .then(() => {
        alert("Im치genes enviadas correctamente");

        imagenes = [];
        document.getElementById("galeria").innerHTML = "";
        document.getElementById("visual").value = "";
        document.getElementById("tituloVisual").value = "";
      })
      .catch(err => {
        console.error(err);
        alert("Error al enviar im치genes");
      });
    }
  </script>

</body>
</html>
