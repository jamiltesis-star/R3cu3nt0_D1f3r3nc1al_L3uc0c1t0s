<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>C√°mara + Env√≠o M√∫ltiple (WebP)</title>
</head>

<input
  type="text"
  id="tituloVisual"
  placeholder="Escribe el t√≠tulo aqu√≠"
  style="width:320px; font-size:16px; margin-bottom:10px;"
>


<body>

  <h3>C√°mara</h3>

  <video id="video" width="320" height="240" autoplay playsinline></video>

  <br><br>

  <button onclick="tomarImagen()">Tomar imagen</button>
  <button onclick="enviarImagenes()">Enviar im√°genes</button>
  <button onclick="cambiarCamara()">Cambiar c√°mara</button>
  <span id="cameraLabel" style="margin-left:8px; font-weight:normal;">C√°mara: ‚Äî</span>

  <br><br>

  <div id="galeria"></div>

  <canvas id="canvas" style="display:none;"></canvas>

  <hr>

  <h4>Base64 acumulado (debug)</h4>
  <textarea id="visual" rows="6" cols="50" readonly></textarea>

  <script>
    let stream = null;

    // üî¥ AQU√ç SE GUARDAN TODAS LAS IM√ÅGENES
    let imagenes = [];

    const URL_GAS = "https://script.google.com/macros/s/AKfycbwsC-K5w5HzlL9ByQ4fwWUUjS0HviZgmstrZnY4tBjNYp7KfnQ9qSxpYl_pxog6fLkQ/exec";

    // Lista de c√°maras y estado actual
    let dispositivosVideo = [];
    let currentDeviceIndex = 0;

    function stopStream() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
      }
    }

    function abrirCamara(deviceId) {
      // Detener stream actual si existe
      stopStream();

      const constraints = deviceId
        ? { video: { deviceId: { exact: deviceId } } }
        : { video: { facingMode: { ideal: "environment" } } };

      return navigator.mediaDevices.getUserMedia(constraints)
        .then(s => {
          stream = s;
          video.srcObject = stream;

          // Actualizar lista de dispositivos (ahora que hay permiso se ven las etiquetas)
          return navigator.mediaDevices.enumerateDevices().then(devs => {
            dispositivosVideo = devs.filter(d => d.kind === 'videoinput');

            // Intentar identificar la c√°mara actual por deviceId
            if (stream && stream.getVideoTracks && stream.getVideoTracks().length) {
              const track = stream.getVideoTracks()[0];
              const settings = track.getSettings ? track.getSettings() : {};
              const currentId = settings.deviceId;
              const idx = dispositivosVideo.findIndex(d => d.deviceId === currentId);
              if (idx !== -1) currentDeviceIndex = idx;
            }

            updateCameraLabel();
          });
        })
        .catch(err => {
          console.error(err);
          alert("No se pudo abrir la c√°mara");
        });
    }

    function listarDispositivos() {
      return navigator.mediaDevices.enumerateDevices()
        .then(devs => {
          dispositivosVideo = devs.filter(d => d.kind === 'videoinput');
          updateCameraLabel();
        })
        .catch(err => {
          console.error('Error listando dispositivos', err);
        });
    }

    function updateCameraLabel() {
      const el = document.getElementById('cameraLabel');
      if (!el) return;
      if (dispositivosVideo.length === 0) {
        el.textContent = 'C√°mara: no detectada';
      } else {
        const d = dispositivosVideo[currentDeviceIndex] || dispositivosVideo[0];
        el.textContent = 'C√°mara: ' + (d.label || `Dispositivo ${currentDeviceIndex + 1}`);
      }
    }

    function cambiarCamara() {
      if (dispositivosVideo.length <= 1) {
        alert('No hay otras c√°maras disponibles');
        return;
      }
      currentDeviceIndex = (currentDeviceIndex + 1) % dispositivosVideo.length;
      const deviceId = dispositivosVideo[currentDeviceIndex].deviceId;
      abrirCamara(deviceId);
    }

    function tomarImagen() {
      if (!video.srcObject) {
        alert("Primero abre la c√°mara");
        return;
      }

      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const galeria = document.getElementById("galeria");

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);

      // Blanco y negro
      const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imgData.data;
      for (let i = 0; i < data.length; i += 4) {
        const g = 0.299 * data[i] + 0.587 * data[i+1] + 0.114 * data[i+2];
        data[i] = data[i+1] = data[i+2] = g;
      }
      ctx.putImageData(imgData, 0, 0);

      // üëâ WebP
      const dataURL = canvas.toDataURL("image/webp", 0.8);

      // Guardar en array
      imagenes.push(dataURL);

      // Mostrar miniatura
      const img = document.createElement("img");
      img.src = dataURL;
      img.width = 120;
      img.style.margin = "5px";
      galeria.appendChild(img);

      // Debug (solo para ver)
      document.getElementById("visual").value =
        `Im√°genes almacenadas: ${imagenes.length}`;
    }

    function enviarImagenes() {
      if (imagenes.length === 0) {
        alert("No hay im√°genes para enviar");
        return;
      }

      const titulo = document.getElementById("tituloVisual").value.trim();

      if (!titulo) {
        alert("Escribe un t√≠tulo antes de enviar");
        return;
      }

      fetch(URL_GAS, {
        method: "POST",
        body: new URLSearchParams({
          titulo: titulo,
          imagenes: JSON.stringify(imagenes)
        })
      })
      .then(r => r.text())
      .then(() => {
        alert("Im√°genes enviadas correctamente");

        imagenes = [];
        document.getElementById("galeria").innerHTML = "";
        document.getElementById("visual").value = "";
        document.getElementById("tituloVisual").value = "";
      })
      .catch(err => {
        console.error(err);
        alert("Error al enviar im√°genes");
      });
    }

    // Inicializaci√≥n: listar dispositivos primero y abrir c√°mara
    listarDispositivos()
      .then(() => abrirCamara())
      .catch(() => {
        // intentar abrir c√°mara de todos modos
        abrirCamara();
      });
  </script>

</body>
</html>

